{% extends "partial_view/main.html" %}
{% load static %}
{% block content %}
    <link href="{% static '/product/css/product.css' %}" rel="stylesheet"/>
    <div class="row product_list">
        <div class="col col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title text-center text-md-left"> All variants </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive product_list_table">
                        <table class="table table-hover" id="product_list">
                            <thead class=" text-primary">
                            <th>ID</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>GSM</th>
                            <th>Size</th>
                            <th>Color</th>
                            <th class="text-right">Price(BDT)</th>
                            <th class="text-center">Discount(%)</th>
                            <th class="text-right">Total Stock</th>
                            </thead>
                            <tbody>
                            {% for product in product_list %}
                                {% for variant in product.product_variant %}
                                    <tr class="product_row"
                                        onclick="redirect_new_page('{% url 'product:variant_details' variant.id %}')"
                                        style="cursor:pointer;" data-variant-order='{{ variant.total_order }}'
                                        data-variant-id='{{ variant.id }}'>
                                        <td>{{ variant.id }}</td>
                                        <td>{{ product.product_name }}</td>
                                        <td>{{ variant.category }}</td>
                                        <td>{{ variant.gsm }}</td>
                                        <td>{{ variant.size }}</td>
                                        <td>{{ variant.color }}</td>
                                        <td class="text-right">{{ variant.price|floatformat:3 }}</td>
                                        <td class="text-center">{{ variant.discount_percent }} <br> <span
                                                style="font-size: 10px;">Min purchase- {{ variant.discount_min_purchase }}</span>
                                        </td>
                                        <td class="text-right">{{ variant.stock_total }}</td>
                                    </tr>
                                {% endfor %}
                                {#                                <thead>#}
                                {#                                <tr>#}
                                {#                                    <th colspan="9" class="text-center product_summery">#}
                                {#                                        Total {{ product.product_name }}#}
                                {#                                        => {{ product.total_stock }}</th>#}
                                {#                                </tr>#}
                                {#                                </thead>#}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
   {% csrf_token %}
{% endblock %}
{% block outside_wrapper %}
    <ul class="ContextMenu ContextMenu--theme-default" id="contextMenu" data-contextmenu="0" tabindex="-1">
        <li class="ContextMenu-item" tabindex="0" id="deleteBtn"
            onclick="confirmDelete()" data-total-order="0" data-variant-id="-1" data-delete-row>
            <i class="fa fa-minus-circle context-menu-icon"></i>
            <strong style="margin-left: 20px;">Delete</strong>
        </li>
    </ul>
{% endblock %}
{% block add_new_js %}
    <script>
        function productListContextMenu() {
            $('.product_row').on('contextmenu', function (e) {
                e.preventDefault();
                $('#contextMenu').css({
                    top: e.pageY + 'px',
                    left: e.pageX + 'px'
                }).addClass('is-open');
                var totalOrder = $(this).data('variantOrder');
                var vairantId = $(this).data('variantId')
                $('#deleteBtn').data('totalOrder', totalOrder);
                $('#deleteBtn').data('variantId', vairantId);
                $('#deleteBtn').data('deleteRow', this);
            })
        }

        function deleteProductItem() {
            var id = $('#deleteBtn').data('variantId');
            var deleteRow = $('#deleteBtn').data('deleteRow');
            var dataTable = $('#product_list').DataTable();
            $.ajax({
                url: window.location.href,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                    variant_id: id
                },
                success: function (data, textStatus, jqXHR) {
                    dataTable.row($(deleteRow)).remove().draw();
                    showToast('Variant has been deleted', 'success');
                },
                error: function (data, textStatus, jqXHR) {
                    showToast('Error occurred while deleting variant', 'error');
                }
            });
        }

        function confirmDelete() {
            var totalOrder = $('#deleteBtn').data('totalOrder');

            if (totalOrder > 0) {
                var action = confirm("This product has " + totalOrder + " transaction. If you delete this then all transaction will be deleted. Do you to delete this product?");
                if (action) {
                    deleteProductItem();
                }
            } else {
                var action = confirm("This product has no transaction. Do you want to delete this product? ");
                if (action) {
                    deleteProductItem();
                }

            }
        }

        $(document).ready(function () {
            initDatatable();
            //preventAutoFormSubmission();
            /*----------------------*/
            productListContextMenu();
            $(document).click(function () {
                $('#contextMenu').removeClass('is-open');
            });

        });
    </script>
{% endblock %}

